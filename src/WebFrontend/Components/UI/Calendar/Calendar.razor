@using WebFrontend.Components.UI.Shared
@using WebFrontend.Services

@* Custom dropdown-style date picker with calendar grid *@
<div class="relative inline-block w-full text-left">
    <button type="button"
            class='@ClassBuilder.Merge("flex w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm shadow-xs outline-none transition-colors focus-visible:border-ring focus-visible:ring-[3px] focus-visible:ring-ring/40 disabled:cursor-not-allowed disabled:opacity-50", Class)'
            disabled="@Disabled"
            @onclick="ToggleAsync">
        <span class="truncate text-left @(Value.HasValue ? "text-foreground" : "text-muted-foreground")">
            @DisplayText
        </span>
        <span class="ml-2 flex items-center text-muted-foreground">
            <svg class="h-4 w-4 transition-transform duration-150 @( _open ? "rotate-180" : "" )"
                 viewBox="0 0 20 20" fill="none" aria-hidden="true">
                <path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
        </span>
    </button>

    @if (_open)
    {
        @* overlay to close on outside click *@
        <div class="fixed inset-0 z-40" @onclick="CloseAsync"></div>

        <div class="absolute z-50 mt-1 w-[260px] overflow-hidden rounded-md border border-border bg-card shadow-lg origin-top @AnimationClass"
             @onclick:stopPropagation="true">
            @* Calendar Header *@
            <div class="flex items-center justify-between px-2.5 py-2 border-b border-border">
                <button type="button"
                        class="flex h-7 w-7 items-center justify-center rounded-md hover:bg-muted transition-colors"
                        @onclick="() => NavigateMonth(-1)">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <div class="flex items-center gap-2">
                    <span class="text-sm font-semibold text-foreground">@CurrentMonthYear</span>
                </div>
                <button type="button"
                        class="flex h-7 w-7 items-center justify-center rounded-md hover:bg-muted transition-colors"
                        @onclick="() => NavigateMonth(1)">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>

            @* Calendar Grid *@
            <div class="px-2.5 py-2">
                @* Weekday Headers *@
                <div class="grid grid-cols-7 gap-0.5 mb-2">
                    @foreach (var day in WeekDays)
                    {
                        <div class="flex h-7 items-center justify-center text-[11px] font-medium text-muted-foreground">
                            @day
                        </div>
                    }
                </div>

                @* Calendar Dates *@
                <div class="grid grid-cols-7 gap-0.5">
                    @foreach (var date in CalendarDates)
                    {
                        var isCurrentMonth = date.Month == _currentMonth.Month && date.Year == _currentMonth.Year;
                        var isSelected = Value.HasValue && date == Value.Value;
                        var isToday = date == DateOnly.FromDateTime(DateTime.Today);
                        var passesRange = IsSelectableByRange(date);
                        var passesMinMax = (!MinDate.HasValue || date >= MinDate.Value) && (!MaxDate.HasValue || date <= MaxDate.Value);
                        var isDisabled = !passesRange || !passesMinMax;

                        <button type="button"
                                disabled="@isDisabled"
                                class="@GetDateButtonClasses(isCurrentMonth, isSelected, isToday, isDisabled)"
                                @onclick="() => SelectDate(date)"
                                @onclick:preventDefault="true">
                            <span class="text-xs">@date.Day</span>
                        </button>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public DateOnly? Value { get; set; }
    [Parameter] public EventCallback<DateOnly?> ValueChanged { get; set; }
    [Parameter] public DateOnly? MinDate { get; set; }
    [Parameter] public DateOnly? MaxDate { get; set; }
    [Parameter] public string? Placeholder { get; set; } = "Pick a date";
    [Parameter] public string? Label { get; set; }
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public string? Class { get; set; }
    [Parameter(CaptureUnmatchedValues = true)] public Dictionary<string, object>? AdditionalAttributes { get; set; }

    [Inject] private ScrollLockService ScrollLockService { get; set; } = default!;

    private bool _open;
    private bool _isClosing;
    private DateTime _currentMonth;

    private readonly string[] WeekDays = new[] { "Su", "Mo", "Tu", "We", "Th", "Fr", "Sa" };

    private string AnimationClass =>
        _isClosing
            ? "animate-[select-out_140ms_cubic-bezier(0.2,0.8,0.2,1)_forwards]"
            : "animate-[select-in_160ms_cubic-bezier(0.2,0.8,0.2,1)_forwards]";

    private string DisplayText
    {
        get
        {
            if (Value.HasValue)
            {
                return Value.Value.ToString("MM/dd/yyyy");
            }
            return Placeholder ?? "Pick a date";
        }
    }

    private string CurrentMonthYear => _currentMonth.ToString("MMMM yyyy");

    private List<DateOnly> CalendarDates
    {
        get
        {
            var dates = new List<DateOnly>();
            var firstDayOfMonth = new DateOnly(_currentMonth.Year, _currentMonth.Month, 1);
            var firstDayOfWeek = (int)firstDayOfMonth.DayOfWeek;

            // Add days from previous month
            var daysFromPreviousMonth = firstDayOfWeek;
            for (int i = daysFromPreviousMonth - 1; i >= 0; i--)
            {
                dates.Add(firstDayOfMonth.AddDays(-i - 1));
            }

            // Add days from current month
            var daysInMonth = DateTime.DaysInMonth(_currentMonth.Year, _currentMonth.Month);
            for (int i = 0; i < daysInMonth; i++)
            {
                dates.Add(new DateOnly(_currentMonth.Year, _currentMonth.Month, i + 1));
            }

            // Add days from next month to fill the grid (6 rows = 42 days total)
            var remainingDays = 42 - dates.Count;
            for (int i = 1; i <= remainingDays; i++)
            {
                dates.Add(firstDayOfMonth.AddMonths(1).AddDays(i - 1));
            }

            return dates;
        }
    }

    private bool IsSelectableByRange(DateOnly date)
    {
        var today = DateOnly.FromDateTime(DateTime.Today);

        return SelectableRange switch
        {
            CalendarSelectableRange.AllDates => true,
            CalendarSelectableRange.PreviousDates => date < today,
            CalendarSelectableRange.PreviousDatesToday => date <= today,
            CalendarSelectableRange.FutureDates => date > today,
            CalendarSelectableRange.FutureDatesToday => date >= today,
            _ => true
        };
    }

    protected override void OnInitialized()
    {
        _currentMonth = Value?.ToDateTime(TimeOnly.MinValue) ?? DateTime.Today;
    }

    protected override void OnParametersSet()
    {
        if (Value.HasValue)
        {
            _currentMonth = Value.Value.ToDateTime(TimeOnly.MinValue);
        }
    }

    private string GetDateButtonClasses(bool isCurrentMonth, bool isSelected, bool isToday, bool isDisabled)
    {
        var baseClasses = "flex h-8 w-8 items-center justify-center rounded-md text-xs transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50";

        if (isDisabled)
        {
            return $"{baseClasses} text-muted-foreground/40 cursor-not-allowed";
        }

        if (isSelected)
        {
            return $"{baseClasses} bg-primary text-primary-foreground hover:bg-primary/90";
        }

        if (isToday && !isSelected)
        {
            return $"{baseClasses} bg-accent text-accent-foreground hover:bg-accent/80";
        }

        if (!isCurrentMonth)
        {
            return $"{baseClasses} text-muted-foreground/50 hover:bg-muted/50";
        }

        return $"{baseClasses} text-foreground hover:bg-muted";
    }

    private async Task ToggleAsync()
    {
        if (Disabled) return;

        if (_open)
        {
            await StartCloseAnimationAsync();
            return;
        }

        // Set current month to selected date or today when opening
        if (Value.HasValue)
        {
            _currentMonth = Value.Value.ToDateTime(TimeOnly.MinValue);
        }
        else
        {
            _currentMonth = DateTime.Today;
        }

        _isClosing = false;
        _open = true;
        await ScrollLockService.LockAsync();
        StateHasChanged();
    }

    private Task CloseAsync()
    {
        if (!_open) return Task.CompletedTask;
        return StartCloseAnimationAsync();
    }

    private async Task SelectDate(DateOnly date)
    {
        if (Disabled) return;

        Value = date;
        if (ValueChanged.HasDelegate)
        {
            await ValueChanged.InvokeAsync(date);
        }

        await StartCloseAnimationAsync();
    }

    private void NavigateMonth(int months)
    {
        _currentMonth = _currentMonth.AddMonths(months);
        StateHasChanged();
    }

    private async Task StartCloseAnimationAsync()
    {
        _isClosing = true;
        StateHasChanged();

        await Task.Delay(140);

        _open = false;
        _isClosing = false;
        await ScrollLockService.UnlockAsync();
        StateHasChanged();
    }
}
